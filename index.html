<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chord Diagram</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #publications {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #f0f0f0;
            color: black;
            padding: 15px;
            border-radius: 0 0 0 8px;
            width: 300px;
            height: 100%;
            overflow-y: auto;
            display: none;
            z-index: 10;
            font-weight: 300;
        }

        #closeButton {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            font-weight: light;
            background: none;
            border: none;
        }
        
        #infoLink {
            display: block;
            margin-top: 20px;
            font-size: 14px;
            color: #007BFF;
            text-decoration: none;
            text-align: center; 
        }

        #infoLink:hover {
            text-decoration: underline;
        }

        #publicationButton {
            display: block;
            margin: 30px auto;
            padding: 10px 20px;
            background-color: black; /* Schwarzer Hintergrund */
            color: white; /* Weiße Schrift */
            border: none; /* Kein Rand */
            border-radius: 20px; /* Oval */
            font-size: 14px;
            cursor: pointer;
            box-shadow: none; /* Kein Schatten */
      
}
        
        #publicationName {
            margin-top: 60px; /* Abstand nach oben für den Namen */
            text-align: center; /* Zentrierung */
            font-size: 28px; /* Größere Schrift für den Namen */
            margin-bottom: 4px; /* Kleiner Abstand nach unten */
        }

        #researcherInstitute {
            margin-top: 0px; /* Geringer Abstand zwischen Name und Institut */
            text-align: center; /* Zentrierung */
            font-size: 18px; /* Etwas kleinere Schrift für das Institut */
            font-weight: 300; /* Dünnere Schrift */
        }

        ul {
            list-style-type: none;
            padding: 0;
            display: none;
        }

        ul li {
            margin-bottom: 15px;
            font-size: 12px;
        }

        ul li span {
            font-weight: bold;
        }

        #controls {
            position: absolute;
            top: 80px; /* Abstand von 80px zum oberen Rand */
            left: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        select {
            padding: 8px;
            font-size: 14px;
            border-radius: 20px; /* Oval */
            border: none; /* Kein Rand */
            width: 200px;
            background-color: black; /* Schwarzer Hintergrund */
            color: white; /* Weiße Schrift */
            box-shadow: none; /* Kein Schatten */
            appearance: none; /* Plattform-unabhängiger Stil */
            outline: none; /* Kein Fokusrahmen */
        }

        /* Dropdown-Menüs im geöffneten Zustand */
        select:focus, select:active {
            background-color: #f0f0f0; /* Grau wie der rechte Kasten */
            color: black; /* Schwarze Schrift */
            border: none; /* Kein Rand */
            box-shadow: none; /* Kein Schatten */
}

        /* Stil für die Überschrift */
        #diagramTitle {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            color: black;
            z-index: 10;
        }

    </style>
</head>
<body>
    <div id="controls">
        <select id="researcherSelect">
            <option value="">Wähle einen Forscher</option>
        </select>
        <select id="institutSelect">
            <option value="">Wähle ein Institut</option>
        </select>
    </div>
    <div id="diagramTitle">Gemeinsame Publikationen</div>
    <svg id="chordDiagram" width="800" height="800"></svg>
    <div id="tooltip" class="tooltip"></div>
    <div id="publications">
        <button id="closeButton">✖</button>
        <h3 id="publicationName"></h3>
        <h4 id="researcherInstitute"></h4>
        <a id="infoLink" href="#" target="_blank">Zum Forschungsprofil</a>
        <button id="publicationButton">Publikationen anzeigen</button>
        <ul id="publicationList"></ul>
    </div>

    <script>
        const jsonDataPath = "output.json"; // Pfad zur JSON-Datei

        const width = 800, height = 800;
        const outerRadius = Math.min(width, height) / 2 - 50;
        const innerRadius = outerRadius - 20;

        const svg = d3.select("#chordDiagram")
            .attr("width", width)
            .attr("height", height)
            .call(d3.zoom().on("zoom", function(event) {
                svg.attr("transform", event.transform);
            }))
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const tooltip = d3.select("#tooltip");
        const publicationsDiv = d3.select("#publications");
        const publicationList = d3.select("#publicationList");
        const publicationButton = d3.select("#publicationButton");

        d3.json(jsonDataPath).then(data => {
            const researchers = data.researchers;
            const connections = data.connections;

            // Forscher nach Institut und Nachname sortieren
            data.researchers.sort((a, b) => {
                if (a.institut < b.institut) return -1;
                if (a.institut > b.institut) return 1;
                return a.nachname.localeCompare(b.nachname);
            });

            // Mapping von Institute zu Farben
            const institutes = [...new Set(researchers.map(r => r.institut))];
            const color = d3.scaleOrdinal()
                .domain(institutes)
                .range(["#FF5733", "#33FF57", "#3357FF", "#F5FF33", "#FF33A1"]); // Beispiel: 5 benutzerdefinierte Farben

            // Forscher nach Institut gruppieren
            const researcherMap = new Map(researchers.map((d, i) => [d.user_id, i]));
            const numResearchers = researchers.length;

            const matrix = Array.from({ length: numResearchers }, () =>
                Array(numResearchers).fill(0)
            );

            connections.forEach(d => {
                const sourceIndex = researcherMap.get(d.source);
                const targetIndex = researcherMap.get(d.target);
                if (sourceIndex !== undefined && targetIndex !== undefined) {
                    matrix[sourceIndex][targetIndex] = d.value;
                }
            });

            const chord = d3.chord()
                .padAngle(0.05)
                .sortSubgroups(d3.descending)
                (matrix);

            const arc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(outerRadius);

            const ribbon = d3.ribbon()
                .radius(innerRadius);

            const group = svg.append("g")
                .selectAll("g")
                .data(chord.groups)
                .join("g");

            group.append("path")
                .attr("d", arc)
                .attr("fill", d => color(researchers[d.index].institut))
                .attr("stroke", d => d3.rgb(color(researchers[d.index].institut)).darker())
                .on("click", (event, d) => {
                    const selectedIndex = d.index;

                    svg.selectAll("path.ribbon")
                        .attr("opacity", ribbon =>
                            ribbon.source.index === selectedIndex || ribbon.target.index === selectedIndex ? 1 : 0.1
                        );

                    const researcher = researchers[d.index];
                    d3.select("#publicationName").text(`${researcher.vorname} ${researcher.nachname}`);
                    d3.select("#researcherInstitute").text(researcher.institut);

                    const lastName = researcher.nachname.toUpperCase(); 
                    const profileLink = `https://phwg-forschung.de/profil.php?fdb=1&info=${lastName}&usersprache=D`;

                    d3.select("#infoLink")
                        .attr("href", profileLink)
                        .text("Zum Forschungsprofil");

                    const publicationIds = researcher.publikations_ids.split(',');
                    const uniquePublicationIds = [...new Set(publicationIds)];

                    const publications = data.publications.filter(pub =>
                        uniquePublicationIds.includes(pub.publication_id.toString())
                    );

                    publicationList.html("");
                    publications
                        .sort((a, b) => b.year - a.year)
                        .forEach(pub => {
                            publicationList.append("li")
                                .html(`<span>${pub.title}</span> (<span>${pub.year}</span>)`);
                        });

                    publicationsDiv.style("display", "block");
                })
                .on("mouseover", (event, d) => {
                    const researcher = researchers[d.index];
                    tooltip.style("opacity", 1)
                        .html(`${researcher.vorname} ${researcher.nachname}`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY + 5) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));

            group.append("text")
                .each(d => { d.angle = (d.startAngle + d.endAngle) / 2; })
                .attr("dy", ".35em")
                .attr("transform", d => `
                    rotate(${d.angle * 180 / Math.PI - 90})
                    translate(${outerRadius + 10})
                    ${d.angle > Math.PI ? "rotate(180)" : ""}
                `)
                .attr("text-anchor", d => d.angle > Math.PI ? "end" : null)
                .text(d => `${researchers[d.index].vorname} ${researchers[d.index].nachname}`);

            svg.append("g")
                .selectAll("path")
                .data(chord)
                .join("path")
                .attr("d", ribbon)
                .attr("fill", d => color(researchers[d.target.index].institut))
                .attr("stroke", d => d3.rgb(color(researchers[d.target.index].institut)).darker())
                .attr("class", "ribbon");

            d3.select("#closeButton").on("click", function() {
                publicationsDiv.style("display", "none");
                svg.selectAll("path.ribbon").attr("opacity", 1);
            });

            publicationButton.on("click", function() {
                const isListVisible = publicationList.style("display") === "block";
                publicationList.style("display", isListVisible ? "none" : "block");
                publicationButton.text(isListVisible ? "Publikationen anzeigen" : "Publikationen verbergen");
            });

            // Fülle das Dropdown mit den Forschern, alphabetisch sortiert
            const researcherSelect = d3.select("#researcherSelect");
            researchers.forEach(researcher => {
                researcherSelect.append("option")
                    .attr("value", researcher.user_id)
                    .text(`${researcher.vorname} ${researcher.nachname}`);
            });

            // Fülle das Institut-Dropdown
            const institutSelect = d3.select("#institutSelect");
            institutes.forEach(institut => {
                institutSelect.append("option")
                    .attr("value", institut)
                    .text(institut);
            });

            // Event für die Auswahl eines Forschers
            researcherSelect.on("change", function() {
                const selectedUserId = this.value;
                if (selectedUserId) {
                    const selectedResearcher = researchers.find(r => r.user_id === selectedUserId);
                    const researcherIndex = researcherMap.get(selectedResearcher.user_id);
                    const selectedIndex = researcherIndex;

                    svg.selectAll("path.ribbon")
                        .attr("opacity", ribbon =>
                            ribbon.source.index === selectedIndex || ribbon.target.index === selectedIndex ? 1 : 0.1
                        );

                    // Update Name und Institut
                    d3.select("#publicationName").text(`${selectedResearcher.vorname} ${selectedResearcher.nachname}`);
                    d3.select("#researcherInstitute").text(selectedResearcher.institut);

                    const lastName = selectedResearcher.nachname.toUpperCase(); 
                    const profileLink = `https://phwg-forschung.de/profil.php?fdb=1&info=${lastName}&usersprache=D`;

                    d3.select("#infoLink")
                        .attr("href", profileLink)
                        .text("Zum Forschungsprofil");

                    // Publikationen für den ausgewählten Forscher laden
                    const publicationIds = selectedResearcher.publikations_ids.split(',');
                    const uniquePublicationIds = [...new Set(publicationIds)];

                    const publications = data.publications.filter(pub =>
                        uniquePublicationIds.includes(pub.publication_id.toString())
                    );

                    publicationList.html("");
                    publications
                        .sort((a, b) => b.year - a.year)
                        .forEach(pub => {
                            publicationList.append("li")
                                .html(`<span>${pub.title}</span> (<span>${pub.year}</span>)`);
                        });

                    publicationsDiv.style("display", "block");
                } else {
                    // Wenn kein Forscher gewählt wurde, setze die Opazität zurück
                    svg.selectAll("path.ribbon").attr("opacity", 1);
                    d3.select("#publicationName").text("");
                    d3.select("#researcherInstitute").text("");
                    publicationList.html("");
                    publicationsDiv.style("display", "none");
                }
            });

            // Event für die Auswahl eines Instituts
            institutSelect.on("change", function() {
                const selectedInstitut = this.value;
                if (selectedInstitut) {
                    svg.selectAll("path")
                        .attr("opacity", d => {
                            const researcher = researchers[d.index];
                            return researcher.institut === selectedInstitut ? 1 : 0.1;
                        });
                } else {
                    svg.selectAll("path").attr("opacity", 1); // Wenn kein Institut gewählt wurde
                }
            });
        });
    </script>
</body>
</html>
